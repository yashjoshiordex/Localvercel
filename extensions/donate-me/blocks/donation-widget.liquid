<script src="{{ 'donation.js' | asset_url }}" defer></script>

<style>
.main-heading {
  color: {{ block.settings.heading_color }}; 
  font-size: {{ block.settings.heading_font_size }}px;
}
.sub-text{
   color: {{ block.settings.text_color }};
   font-size: {{ block.settings.subtext_font_size }}px;
}
.preset-button {
    background-color: {{ block.settings.button_color }};
    color: #fff;
    padding: 15px 28px;
    font-size: 14px;
    border: none;
    cursor: pointer;
    margin-right: 10px;
    margin-top: 5px;
    border-radius: 4px;
  }
</style>

{% if block.settings.product %}
  {% assign selected_product = all_products[block.settings.product] %}

  {% if selected_product %}
    <div class="donation-widget" style="display: flex; gap: 170px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; align-items: flex-start; flex-wrap: wrap;">

      {% if block.settings.show_image and selected_product.featured_image %}
        <div style="flex: 1; min-width: 400px;">
          <img
            src="{{ selected_product.featured_image | image_url: width: 400 }}"
            alt="Product image"
            width="100%"
            style="max-width: 100%; border-radius: 8px;"
          >
        </div>
      {% endif %}

      <div style="flex: 2; min-width: 280px;">
        {% if block.settings.show_title %}
          <h2 class="main-heading" style="margin-top: 0;">{{ selected_product.title }}</h2>
        {% endif %}

        {% if block.settings.show_description %}
          <p class="sub-text" style="line-height: 1.6; margin-top: 10px;">
            {{ selected_product.description | strip_html | truncate: 150 }}
          </p>
        {% endif %}

        <form id="donate-form" data-product-id="{{ selected_product.id }}" style="margin-top: 40px;">
          <label for="donation-amount" style="display: block; font-weight: bold; font-size: 16px; margin-bottom: 5px;">
            Enter Amount
          </label>

          <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            {% if block.settings.show_currency %}
              <select style="padding: 5px 10px; font-size: 14px;">
                <option selected>{{ cart.currency.iso_code }} - $</option>
              </select>
            {% endif %}

            <input
              type="number"
              id="donation-amount"
              min="1"
              step="1"
              value="{{ block.settings.default_amount }}"
              required
              style="padding: 16px 10px; font-size: 18px; width: 140px; border: 1px solid #ccc"
            >

            
          </div>

          {% assign preset_values = selected_product.metafields.donate.preset_value.value %}
          {% if preset_values %}
            <div style="margin-top: 10px;">
              {% for amount in preset_values %}
                <button
                  type="button"
                  class="preset-button"
                  data-amount="{{ amount }}"
                  
                >
                  {{ amount }}
                </button>
              {% endfor %}
            </div>
          {% endif %}
        </form>
      </div>
    </div>
    
  {% else %}
    <div
      id="donation-widget"
      data-product-id="{{ product.id | json }}"
      data-api-endpoint="{{ app.metafields.custom.donation_api_url | default: '/apps/donation/create-variant' }}"
    >
      <input type="number" id="donation-amount" placeholder="Enter donation amount">
      <button id="donate-btn">Donate</button>
    </div>


    <script>
      (function () {
        document.getElementById('donate-btn')?.addEventListener('click', async () => {
          const amount = document.getElementById('donation-amount').value;
          const widget = document.getElementById('donation-widget');
          const productId = widget.dataset.productId;
          const apiEndpoint = widget.dataset.apiEndpoint;

          if (!amount || isNaN(amount)) {
            alert('Please enter a valid donation amount');
            return;
          }

          try {
            const res = await fetch(apiEndpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productId, price: amount }),
            });

            const data = await res.json();
            const variantId = data.variantId?.split('/')?.pop();

            if (!variantId) {
              alert('Something went wrong. Try again.');
              return;
            }

            await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ items: [{ id: parseInt(variantId), quantity: 1 }] }),
            });

            window.location.href = '/cart';
          } catch (err) {
            console.error(err);
            alert('Error occurred. Please try again.');
          }
        });
      })();
    </script>

    <div style="padding: 1em; background: #fff3cd; border: 1px solid #ffeeba;">
      The selected product could not be found. Please reselect a valid product in the settings.
    </div>
  {% endif %}
{% else %}
  <div style="padding: 1em; background: #fff3cd; border: 1px solid #ffeeba;">
    <strong>No product selected.</strong> Please select a donation product in the section settings.
  </div>
{% endif %}

<h4 class="text-center my-3">Total Cost Data 89$</h4>
<div style="background-color: #e0e0e0; border-radius: 10px; height: 40px; width: 100%; margin-top: 10px;">
    <div style="width: 60%; height: 100%; background-color: red; border-radius: 10px; text-align: center; color: white; line-height: 20px;margin-top:10px">
      
    </div>
  </div>
  <h4 class="text-center my-3">Total Cost Data 89$</h4>
{% schema %}
{
  "name": "Donation Widget",
  "target": "section",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Select your Donation Product"
    },
    {
      "type": "number",
      "id": "default_amount",
      "label": "Default Donation Amount",
      "default": 5
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show Title",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show Description",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_currency",
      "label": "Show Currency",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_image",
      "label": "Show Image",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_presets",
      "label": "Show Preset Values",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_recurring",
      "label": "Display Recurring Options",
      "default": false
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Subtext Color",
      "default": "#000000"
    },
    { 
      "type": "range",
      "id": "heading_font_size",
      "label": "Heading Font Size",
      "min": 12,
      "max": 48,
      "step": 1,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "subtext_font_size",
      "label": "Subtext Font Size",
      "min": 10,
      "max": 36,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
  "type": "color",
  "id": "button_color",
  "label": "Button Background",
  "default": "#000000"
}

  ]
}
{% endschema %}
